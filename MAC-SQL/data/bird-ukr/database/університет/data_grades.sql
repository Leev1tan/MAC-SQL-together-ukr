-- Дані про оцінки для бази даних "Університет"
-- Encoding: UTF-8

-- =============================================
-- Оцінки студентів
-- =============================================

-- Функція для генерації випадкової оцінки в межах допустимого діапазону
CREATE OR REPLACE FUNCTION random_grade(min_grade NUMERIC, max_grade NUMERIC) RETURNS NUMERIC AS $$
BEGIN
    RETURN ROUND((random() * (max_grade - min_grade) + min_grade)::NUMERIC, 1);
END;
$$ LANGUAGE plpgsql;

-- Вставляємо оцінки для студентів групи КН-11 з курсу "Основи програмування"
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Лабораторна робота 1',
    '2023-09-15'::DATE,
    random_grade(60, 100),
    100,
    CASE 
        WHEN random_grade(60, 100) < 70 THEN 'Потрібно доопрацювати'
        WHEN random_grade(60, 100) < 85 THEN 'Добре виконана робота'
        ELSE 'Відмінно виконана робота'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Сидоренко' AND імя = 'Анна')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ОП-001' 
    AND г.назва = 'КН-11'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Лабораторна');

-- Вставляємо оцінки для студентів групи КН-11 з курсу "Основи програмування" - друга лаб. робота
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Лабораторна робота 2',
    '2023-09-29'::DATE,
    random_grade(60, 100),
    100,
    CASE 
        WHEN random_grade(60, 100) < 70 THEN 'Потрібно доопрацювати'
        WHEN random_grade(60, 100) < 85 THEN 'Добре виконана робота'
        ELSE 'Відмінно виконана робота'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Сидоренко' AND імя = 'Анна')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ОП-001' 
    AND г.назва = 'КН-11'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Лабораторна');

-- Вставляємо оцінки для студентів групи КН-11 з курсу "Основи програмування" - Модульний контроль
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Модульний контроль',
    '2023-10-15'::DATE,
    random_grade(60, 100),
    100,
    CASE 
        WHEN random_grade(60, 100) < 70 THEN 'Потрібно краще готуватись'
        WHEN random_grade(60, 100) < 85 THEN 'Добрий рівень знань'
        ELSE 'Відмінний рівень знань'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Шевченко' AND імя = 'Віктор')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ОП-001' 
    AND г.назва = 'КН-11'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Лекція');

-- Вставляємо оцінки для студентів групи КН-11 з курсу "Дискретна математика" - Контрольна робота
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Контрольна робота',
    '2023-10-10'::DATE,
    random_grade(60, 100),
    100,
    CASE 
        WHEN random_grade(60, 100) < 70 THEN 'Необхідно покращити знання'
        WHEN random_grade(60, 100) < 85 THEN 'Хороший рівень знань'
        ELSE 'Відмінне розуміння матеріалу'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Кравченко' AND імя = 'Наталія')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ДМ-001' 
    AND г.назва = 'КН-11'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Практичне');

-- Вставляємо оцінки для студентів групи КН-21 з курсу "Об'єктно-орієнтоване програмування" - Лабораторні роботи
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Лабораторна робота 1',
    '2023-09-20'::DATE,
    random_grade(60, 100),
    100,
    CASE 
        WHEN random_grade(60, 100) < 70 THEN 'Потрібно покращити роботу'
        WHEN random_grade(60, 100) < 85 THEN 'Добре розуміння ООП'
        ELSE 'Відмінне виконання завдання'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Сидоренко' AND імя = 'Анна')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ООП-001' 
    AND г.назва = 'КН-21'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Лабораторна');

-- Вставляємо оцінки для студентів групи КН-21 з курсу "Алгоритми та структури даних" - Лабораторні роботи
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Лабораторна робота 1',
    '2023-09-22'::DATE,
    random_grade(60, 100),
    100,
    CASE 
        WHEN random_grade(60, 100) < 70 THEN 'Потрібно допрацювати алгоритми'
        WHEN random_grade(60, 100) < 85 THEN 'Хороша реалізація алгоритмів'
        ELSE 'Відмінна оптимізація алгоритмів'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Коваленко' AND імя = 'Ігор')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'АСД-001' 
    AND г.назва = 'КН-21'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Лабораторна');

-- Вставляємо оцінки для студентів групи ПІ-31 з курсу "Інженерія програмного забезпечення" - Проект
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Проектна робота',
    '2023-10-25'::DATE,
    random_grade(70, 100),
    100,
    CASE 
        WHEN random_grade(70, 100) < 80 THEN 'Потрібно допрацювати проект'
        WHEN random_grade(70, 100) < 90 THEN 'Хороша робота над проектом'
        ELSE 'Відмінний проект з високою якістю коду'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Литвиненко' AND імя = 'Максим')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ІПЗ-001' 
    AND г.назва = 'ПІ-31'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Практичне');

-- Вставляємо оцінки для студентів групи ПІ-31 з курсу "Якість програмного забезпечення та тестування" - Тестовий проект
INSERT INTO оцінки (запис_на_курс_ід, тип_оцінювання, дата, оцінка, максимальна_оцінка, коментар, викладач_ід)
SELECT 
    з.ід,
    'Тестовий проект',
    '2023-10-28'::DATE,
    random_grade(70, 100),
    100,
    CASE 
        WHEN random_grade(70, 100) < 80 THEN 'Потрібно покращити покриття тестами'
        WHEN random_grade(70, 100) < 90 THEN 'Хороше покриття тестами'
        ELSE 'Відмінне покриття тестами, всі сценарії враховані'
    END,
    (SELECT ід FROM викладачі WHERE прізвище = 'Захарченко' AND імя = 'Дмитро')
FROM 
    записи_на_курси з
    JOIN заняття зан ON з.заняття_ід = зан.ід
    JOIN курси к ON зан.курс_ід = к.ід
    JOIN групи г ON зан.група_ід = г.ід
WHERE 
    к.код = 'ЯПЗТ-001' 
    AND г.назва = 'ПІ-31'
    AND зан.тип_заняття_ід = (SELECT ід FROM типи_занять WHERE назва = 'Лабораторна');

-- Видаляємо тимчасову функцію
DROP FUNCTION IF EXISTS random_grade;

-- Оновлюємо середній бал студентів на основі отриманих оцінок
UPDATE студенти с
SET середній_бал = (
    SELECT ROUND(AVG(о.оцінка), 2)
    FROM оцінки о
    JOIN записи_на_курси з ON о.запис_на_курс_ід = з.ід
    WHERE з.студент_ід = с.ід
); 